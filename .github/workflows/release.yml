name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: false
        default: 'manual-build'

# Note: OpenSSL, ZLIB, and RNNoise are optional dependencies.
# - Without OpenSSL: WebSocket connections will be unencrypted
# - Without ZLIB: WebSocket compression disabled  
# - Without RNNoise: Noise cancellation disabled
# The build will succeed without these - they are gracefully disabled if not found.

env:
  QT_VERSION: '6.8.0'
  BUILD_TYPE: Release
  APP_NAME: 'TalkLess'

jobs:
  # ============================================================================
  # macOS Build - Universal Binary (Intel + Apple Silicon)
  # ============================================================================
  build-macos:
    runs-on: macos-14
    strategy:
      matrix:
        arch: [clang_64]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Get version info
        id: version
        run: |
          if [[ "${{ github.ref_name }}" == v* ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_clean=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: 'mac'
          target: 'desktop'
          arch: ${{ matrix.arch }}
          modules: 'qtmultimedia'
          cache: true
          set-env: true

      - name: Set Qt paths
        run: |
          echo "QT_PATH=${QT_ROOT_DIR}" >> $GITHUB_ENV
          echo "Qt installed at: ${QT_ROOT_DIR}"
          ls -la "${QT_ROOT_DIR}/bin/" | head -10

      - name: Install build dependencies
        run: |
          brew install create-dmg
          # Install optional deps for enhanced features (build succeeds without them)
          brew install openssl@3 zlib || true
          echo "OPENSSL_ROOT_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV

      - name: Configure CMake (Universal Binary)
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_PREFIX_PATH="${QT_ROOT_DIR}" \
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET="11.0" \
            -DOPENSSL_ROOT_DIR="${OPENSSL_ROOT_DIR}"

      - name: Build application
        run: |
          cmake --build build --config ${{ env.BUILD_TYPE }} --parallel $(sysctl -n hw.ncpu)

      - name: Verify build output
        run: |
          echo "=== Build output ==="
          ls -la build/
          if [ ! -d "build/appTalkLess.app" ]; then
            echo "❌ ERROR: App bundle not found!"
            exit 1
          fi
          echo "✅ App bundle created successfully"

      - name: Deploy Qt frameworks and plugins
        run: |
          echo "=== Deploying Qt dependencies ==="
          
          # Run macdeployqt to bundle all Qt frameworks, plugins, and QML modules
          "${QT_ROOT_DIR}/bin/macdeployqt" build/appTalkLess.app \
            -qmldir=qml \
            -verbose=2 \
            -always-overwrite
          
          echo "=== Verifying deployed frameworks ==="
          ls -la "build/appTalkLess.app/Contents/Frameworks/" || echo "No Frameworks dir"
          ls -la "build/appTalkLess.app/Contents/PlugIns/" || echo "No PlugIns dir"

      - name: Fix library paths and sign
        run: |
          echo "=== Fixing library paths ==="
          
          # Ad-hoc sign for local testing (replace with proper signing for distribution)
          codesign --force --deep --sign - "build/appTalkLess.app"
          
          # Verify the app can launch
          echo "=== Verifying app structure ==="
          find "build/appTalkLess.app" -name "*.dylib" -o -name "*.framework" | head -20

      - name: Create DMG installer
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Create a nice DMG with background and layout
          create-dmg \
            --volname "${{ env.APP_NAME }} ${VERSION}" \
            --volicon "build/appTalkLess.app/Contents/Resources/appTalkLess.icns" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "appTalkLess.app" 150 190 \
            --app-drop-link 450 190 \
            --hide-extension "appTalkLess.app" \
            "${{ env.APP_NAME }}-${VERSION}-macOS-Universal.dmg" \
            "build/appTalkLess.app" || {
              # Fallback to simple DMG if create-dmg fails
              echo "create-dmg failed, using hdiutil fallback"
              hdiutil create -volname "${{ env.APP_NAME }}" \
                -srcfolder "build/appTalkLess.app" \
                -ov -format UDZO \
                "${{ env.APP_NAME }}-${VERSION}-macOS-Universal.dmg"
            }

      - name: Create ZIP archive
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd build
          zip -r -y "../${{ env.APP_NAME }}-${VERSION}-macOS-Universal.zip" appTalkLess.app

      - name: Generate checksums (macOS)
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          shasum -a 256 "${{ env.APP_NAME }}-${VERSION}-macOS-Universal.dmg" > "${{ env.APP_NAME }}-${VERSION}-macOS-Universal.dmg.sha256"
          shasum -a 256 "${{ env.APP_NAME }}-${VERSION}-macOS-Universal.zip" > "${{ env.APP_NAME }}-${VERSION}-macOS-Universal.zip.sha256"

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: TalkLess-macOS-DMG
          path: |
            ${{ env.APP_NAME }}-*-macOS-Universal.dmg
            ${{ env.APP_NAME }}-*-macOS-Universal.dmg.sha256
          retention-days: 30
          if-no-files-found: error

      - name: Upload macOS ZIP
        uses: actions/upload-artifact@v4
        with:
          name: TalkLess-macOS-ZIP
          path: |
            ${{ env.APP_NAME }}-*-macOS-Universal.zip
            ${{ env.APP_NAME }}-*-macOS-Universal.zip.sha256
          retention-days: 30
          if-no-files-found: error

  # ============================================================================
  # Windows Build - x64 with all dependencies
  # ============================================================================
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Get version info
        id: version
        shell: pwsh
        run: |
          if ("${{ github.ref_name }}" -match "^v") {
            $version = "${{ github.ref_name }}"
          } else {
            $shortHash = git rev-parse --short HEAD
            $version = "dev-$shortHash"
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "version_clean=$($version -replace '^v', '')" >> $env:GITHUB_OUTPUT

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2022_64'
          modules: 'qtmultimedia'
          cache: true
          set-env: true

      - name: Set Qt paths
        shell: pwsh
        run: |
          echo "QT_PATH=$env:QT_ROOT_DIR" >> $env:GITHUB_ENV
          Write-Host "Qt installed at: $env:QT_ROOT_DIR"
          Get-ChildItem "$env:QT_ROOT_DIR\bin" | Select-Object -First 10

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Ninja
        run: choco install ninja -y

      # Note: OpenSSL and ZLIB are optional - enables TLS for WebSockets if available
      # The build will succeed without them - features gracefully disabled

      - name: Configure CMake
        shell: pwsh
        run: |
          cmake -B build -G "Ninja" `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DCMAKE_PREFIX_PATH="$env:QT_ROOT_DIR" `
            -DCMAKE_C_COMPILER=cl `
            -DCMAKE_CXX_COMPILER=cl

      - name: Build application
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      - name: Verify build output
        shell: pwsh
        run: |
          Write-Host "=== Build output ==="
          Get-ChildItem build/
          if (-not (Test-Path "build/appTalkLess.exe")) {
            Write-Error "❌ ERROR: Executable not found!"
            exit 1
          }
          Write-Host "✅ Executable created successfully"
          
          # Show executable info
          $exe = Get-Item "build/appTalkLess.exe"
          Write-Host "Executable size: $([math]::Round($exe.Length / 1MB, 2)) MB"

      - name: Deploy Qt dependencies (Windows)
        shell: pwsh
        run: |
          Write-Host "=== Deploying Qt dependencies ==="
          
          # Create deployment directory
          New-Item -ItemType Directory -Force -Path "deploy"
          
          # Copy main executable
          Copy-Item "build/appTalkLess.exe" "deploy/"
          
          # Run windeployqt to gather all DLLs, plugins, and QML modules
          $windeployqt = Join-Path $env:QT_ROOT_DIR "bin/windeployqt.exe"
          
          & $windeployqt `
            --release `
            --no-translations `
            --no-system-d3d-compiler `
            --no-opengl-sw `
            --qmldir "qml" `
            --dir "deploy" `
            "deploy/appTalkLess.exe"
          
          Write-Host "=== Deployed files ==="
          Get-ChildItem "deploy" -Recurse | Select-Object FullName, Length | Format-Table -AutoSize

      - name: Add Visual C++ Runtime
        shell: pwsh
        run: |
          # Copy VC++ runtime DLLs (these are required for MSVC builds)
          $vcRedistPath = "${env:VCToolsRedistDir}x64\Microsoft.VC143.CRT"
          if (Test-Path $vcRedistPath) {
            Copy-Item "$vcRedistPath\*.dll" "deploy/" -Force
            Write-Host "✅ VC++ Runtime DLLs copied"
          } else {
            Write-Host "⚠️ VC++ Runtime path not found, DLLs may need to be installed separately"
          }

      - name: Verify all dependencies
        shell: pwsh
        run: |
          Write-Host "=== Final deployment contents ==="
          $files = Get-ChildItem "deploy" -Recurse -File
          $totalSize = ($files | Measure-Object -Property Length -Sum).Sum
          Write-Host "Total files: $($files.Count)"
          Write-Host "Total size: $([math]::Round($totalSize / 1MB, 2)) MB"
          
          Write-Host "`n=== DLL files ==="
          Get-ChildItem "deploy" -Filter "*.dll" | Select-Object Name, @{N='Size(KB)';E={[math]::Round($_.Length/1KB,1)}} | Format-Table
          
          Write-Host "`n=== Plugin directories ==="
          Get-ChildItem "deploy" -Directory | ForEach-Object {
            $count = (Get-ChildItem $_.FullName -Recurse -File).Count
            Write-Host "$($_.Name): $count files"
          }

      - name: Create Inno Setup installer
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version_clean }}"
          $versionTag = "${{ steps.version.outputs.version }}"
          
          $installerScript = @"
          #define MyAppName "${{ env.APP_NAME }}"
          #define MyAppVersion "$version"
          #define MyAppPublisher "TalkLess Team"
          #define MyAppURL "https://github.com/${{ github.repository }}"
          #define MyAppExeName "appTalkLess.exe"
          
          [Setup]
          AppId={{A1B2C3D4-E5F6-7890-ABCD-EF1234567890}
          AppName={#MyAppName}
          AppVersion={#MyAppVersion}
          AppVerName={#MyAppName} {#MyAppVersion}
          AppPublisher={#MyAppPublisher}
          AppPublisherURL={#MyAppURL}
          AppSupportURL={#MyAppURL}/issues
          AppUpdatesURL={#MyAppURL}/releases
          DefaultDirName={autopf}\{#MyAppName}
          DefaultGroupName={#MyAppName}
          AllowNoIcons=yes
          LicenseFile=
          OutputDir=.
          OutputBaseFilename=${{ env.APP_NAME }}-${versionTag}-Windows-x64-Setup
          SetupIconFile=
          Compression=lzma2/ultra64
          SolidCompression=yes
          WizardStyle=modern
          ArchitecturesAllowed=x64compatible
          ArchitecturesInstallIn64BitMode=x64compatible
          PrivilegesRequired=lowest
          PrivilegesRequiredOverridesAllowed=dialog
          
          [Languages]
          Name: "english"; MessagesFile: "compiler:Default.isl"
          
          [Tasks]
          Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked
          Name: "quicklaunchicon"; Description: "{cm:CreateQuickLaunchIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked; OnlyBelowVersion: 6.1; Check: not IsAdminInstallMode
          
          [Files]
          Source: "deploy\{#MyAppExeName}"; DestDir: "{app}"; Flags: ignoreversion
          Source: "deploy\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs
          
          [Icons]
          Name: "{group}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"
          Name: "{group}\{cm:UninstallProgram,{#MyAppName}}"; Filename: "{uninstallexe}"
          Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: desktopicon
          Name: "{userappdata}\Microsoft\Internet Explorer\Quick Launch\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: quicklaunchicon
          
          [Run]
          Filename: "{app}\{#MyAppExeName}"; Description: "{cm:LaunchProgram,{#StringChange(MyAppName, '&', '&&')}}"; Flags: nowait postinstall skipifsilent
          
          [UninstallDelete]
          Type: filesandordirs; Name: "{app}"
          "@
          
          $installerScript | Out-File -FilePath "installer.iss" -Encoding UTF8
          
          Write-Host "=== Running Inno Setup Compiler ==="
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "installer.iss"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Inno Setup compilation failed!"
            exit 1
          }

      - name: Create portable ZIP
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $zipName = "${{ env.APP_NAME }}-${version}-Windows-x64-Portable.zip"
          
          Compress-Archive -Path "deploy\*" -DestinationPath $zipName -CompressionLevel Optimal
          
          Write-Host "✅ Created portable ZIP: $zipName"
          Write-Host "Size: $([math]::Round((Get-Item $zipName).Length / 1MB, 2)) MB"

      - name: Generate checksums (Windows)
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          
          $files = @(
            "${{ env.APP_NAME }}-${version}-Windows-x64-Setup.exe",
            "${{ env.APP_NAME }}-${version}-Windows-x64-Portable.zip"
          )
          
          foreach ($file in $files) {
            if (Test-Path $file) {
              $hash = (Get-FileHash $file -Algorithm SHA256).Hash.ToLower()
              "$hash  $file" | Out-File -FilePath "$file.sha256" -Encoding UTF8 -NoNewline
              Write-Host "SHA256($file) = $hash"
            }
          }

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: TalkLess-Windows-Installer
          path: |
            ${{ env.APP_NAME }}-*-Windows-x64-Setup.exe
            ${{ env.APP_NAME }}-*-Windows-x64-Setup.exe.sha256
          retention-days: 30
          if-no-files-found: error

      - name: Upload Windows Portable
        uses: actions/upload-artifact@v4
        with:
          name: TalkLess-Windows-Portable
          path: |
            ${{ env.APP_NAME }}-*-Windows-x64-Portable.zip
            ${{ env.APP_NAME }}-*-Windows-x64-Portable.zip.sha256
          retention-days: 30
          if-no-files-found: error

  # ============================================================================
  # Create GitHub Release
  # ============================================================================
  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          echo "=== Downloaded artifacts ==="
          find artifacts -type f -exec ls -lh {} \;
          
          # Move all files to release directory
          mkdir -p release
          find artifacts -type f \( -name "*.dmg" -o -name "*.zip" -o -name "*.exe" -o -name "*.sha256" \) -exec mv {} release/ \;
          
          echo "=== Release files ==="
          ls -lh release/

      - name: Generate release notes
        id: notes
        run: |
          VERSION="${{ github.ref_name }}"
          
          cat << 'EOF' > release_notes.md
          ## What's New
          
          See the [full changelog](https://github.com/${{ github.repository }}/compare/$(git describe --tags --abbrev=0 HEAD^)...${{ github.ref_name }}) for details.
          
          ## Downloads
          
          | Platform | Type | File |
          |----------|------|------|
          | **macOS** (Universal) | DMG Installer | `TalkLess-${{ github.ref_name }}-macOS-Universal.dmg` |
          | **macOS** (Universal) | ZIP Archive | `TalkLess-${{ github.ref_name }}-macOS-Universal.zip` |
          | **Windows** (x64) | Installer | `TalkLess-${{ github.ref_name }}-Windows-x64-Setup.exe` |
          | **Windows** (x64) | Portable | `TalkLess-${{ github.ref_name }}-Windows-x64-Portable.zip` |
          
          ## Installation
          
          ### macOS
          1. Download the `.dmg` file
          2. Open the DMG and drag TalkLess to your Applications folder
          3. Right-click the app and select "Open" (first launch only, due to unsigned app)
          
          ### Windows
          - **Installer**: Run the `.exe` setup file and follow the wizard
          - **Portable**: Extract the `.zip` file and run `appTalkLess.exe`
          
          ## Verify Downloads
          
          Each download includes a `.sha256` checksum file. Verify your download:
          
          ```bash
          # macOS/Linux
          shasum -a 256 -c TalkLess-${{ github.ref_name }}-*.sha256
          
          # Windows (PowerShell)
          Get-FileHash <filename> -Algorithm SHA256
          ```
          
          ## System Requirements
          
          - **macOS**: macOS 11.0 (Big Sur) or later (Intel & Apple Silicon)
          - **Windows**: Windows 10/11 (64-bit)
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ env.APP_NAME }} ${{ github.ref_name }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') || contains(github.ref_name, '-rc') }}
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
