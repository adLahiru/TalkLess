name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: false
        default: 'manual-build'

env:
  QT_VERSION: '6.8.0'
  BUILD_TYPE: Release

jobs:
  build-macos:
    runs-on: macos-14
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: 'mac'
          target: 'desktop'
          arch: 'clang_64'
          modules: 'qtmultimedia'
          cache: true

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_PREFIX_PATH=${{ env.Qt6_DIR }} \
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64"

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      - name: Deploy Qt dependencies (macOS)
        run: |
          cd build
          ${{ env.Qt6_DIR }}/bin/macdeployqt appTalkLess.app -qmldir=../qml -dmg

      - name: Rename DMG
        run: |
          VERSION=${{ github.ref_name }}
          if [ "$VERSION" = "manual-build" ] || [ -z "$VERSION" ]; then
            VERSION="dev"
          fi
          mv build/appTalkLess.dmg "TalkLess-${VERSION}-macOS.dmg"

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: TalkLess-macOS
          path: TalkLess-*.dmg
          retention-days: 30

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2022_64'
          modules: 'qtmultimedia'
          cache: true

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Configure CMake
        run: |
          cmake -B build -G "Ninja" `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DCMAKE_PREFIX_PATH="$env:Qt6_DIR"

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      - name: Deploy Qt dependencies (Windows)
        shell: cmd
        run: |
          mkdir deploy
          copy build\appTalkLess.exe deploy\
          cd deploy
          %Qt6_DIR%\bin\windeployqt.exe --qmldir ..\qml --release appTalkLess.exe

      - name: Create installer with Inno Setup
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}"
          if ($version -eq "manual-build" -or [string]::IsNullOrEmpty($version)) {
            $version = "dev"
          }
          $version = $version -replace '^v', ''
          
          @"
          [Setup]
          AppName=TalkLess
          AppVersion=$version
          AppPublisher=TalkLess Team
          DefaultDirName={autopf}\TalkLess
          DefaultGroupName=TalkLess
          OutputDir=.
          OutputBaseFilename=TalkLess-${{ github.ref_name }}-Windows-Setup
          Compression=lzma2
          SolidCompression=yes
          ArchitecturesInstallIn64BitMode=x64compatible
          
          [Files]
          Source: "deploy\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs
          
          [Icons]
          Name: "{group}\TalkLess"; Filename: "{app}\appTalkLess.exe"
          Name: "{commondesktop}\TalkLess"; Filename: "{app}\appTalkLess.exe"
          
          [Run]
          Filename: "{app}\appTalkLess.exe"; Description: "Launch TalkLess"; Flags: nowait postinstall skipifsilent
          "@ | Out-File -FilePath installer.iss -Encoding UTF8
          
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss

      - name: Create portable ZIP
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}"
          if ($version -eq "manual-build" -or [string]::IsNullOrEmpty($version)) {
            $version = "dev"
          }
          Compress-Archive -Path deploy\* -DestinationPath "TalkLess-$version-Windows-Portable.zip"

      - name: Upload Windows installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: TalkLess-Windows-Installer
          path: TalkLess-*-Windows-Setup.exe
          retention-days: 30

      - name: Upload Windows portable artifact
        uses: actions/upload-artifact@v4
        with:
          name: TalkLess-Windows-Portable
          path: TalkLess-*-Windows-Portable.zip
          retention-days: 30

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: TalkLess ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') || contains(github.ref_name, '-rc') }}
          generate_release_notes: true
          files: |
            artifacts/TalkLess-macOS/*
            artifacts/TalkLess-Windows-Installer/*
            artifacts/TalkLess-Windows-Portable/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
